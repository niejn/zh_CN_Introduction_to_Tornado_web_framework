#第三章

**模板扩展**

**Extending Templates**

在第二章中，见识了如何使用Tornado模板系统，来轻易地将信息从请求处理器（handlers）传递给web页面，同时在方便地插入动态数据时，还能保持web标记的干净整洁。但是，大部分站点都会要利用到多用途内容，比如页面头部、底部及布局网格等（most site will want to make use of repurposable content like headers, footers, and layout grids）。本章中，就会研究如何通过拓展Tornado模板（by extending Tornado templates），或者说通过使用UI模块（UI modules），达到这个目的。

##HTML块及置换

**Blocks and Substitutions**

在费时费力地为web应用建立并设计好模板后，就会理所当然地想要尽可能多地在Python后端重用这些前端代码，对不对？还好！Tornado可以让你这样做。**通过其`extend`和`block`语句，Tornado支持模板继承**（template inheritance），此特性给予了制作流畅的、在适当时候具备多种用途的模板的掌控与灵活性（give you the control and flexibility to make fluid templates that can be repurposed as you see fit）。

要扩展某个现有模板，只需在新的模板文件顶部，放上`{% extends “filename.html” %}`。比如使用下面的方式，就可以将一个父模板(a parent template, 这里是*main.html*)，扩展进入某个新的模板中。

`{% extends "main.html" %}`

这就会令到新的文件继承*main.html*中的所有标签，并接着改写那些需要改写的内容。有了此系统，就可以创建出一些主模板，转换进入其它为特殊需求的子页面，且同时有着可用的默认及动态文本和标签（With this system, you can create master templates, switch in other sub-pages for special needs, and have both default and dynamic text and markup ready to go）。


###块基础

**Basics of Blocks**

模板扩展令到重复使用先前编写的内容容易起来，但除非能**适用并修改这些先前的模板**，那也是没什么用的。**`block`语句**正是为解决这个问题。

**块语句将某个模板中的一些在扩展该模板时打算改变的元素封装起来**。比如，为运用上一个在每个页面中都可重写的动态头部，就可以将该头部放在父模板*main.html*中。


```html
    <head>
    {% block header %}{% end %}
    </head>
```

接着，要从其子模板（the child template）*index.html*重写那个`{% block header %}{% end %}`部分，就只需要引用那个名字的块，并将想要的任何内容放入就可以了。

```python

{% extends main.html %}

{% block header %}
    <h1>Hello, world!</h1>
{% end %}

任何继承了该模板的文件，都可以包含上其自己的`{% block header %}`及`{% end %}`标签，来同样插入一些不同的内容。

而要从web应用调用这个子模板，只需像之前渲染其它模板一样，从Python脚本对其进行渲染即可。如下面这样。

```python
class MainHandler(tornado.web.RequestHandler):
    def get(self):
        self.render("index.html")
```

那么在这里，装入*index.html*时，来自*main.html*的`body`区块就会以消息“Hello world!”填充（见图3-1）。

好了，可以看看这项特性在处理整个页面结构时会多么有用，同时在多页面站点上多么节约时间。更棒的是，可为所有页面都用上多个的块，那么像是页面头部和底部这样的动态元素就可以包含在同一个流中（Better yet, you can make use of multiple blocks for each page, so dynamic elements like headers and footers can be included in the same flow）。

作为一个示例，将多个区块加入到父模板*main.html*中。

```html
<html>
    <body>
        <header>
            {% block header %}{% end %}
        </header>
        <content>
            {% block body %}{% end %}
        </content>
        <footer>
            {% block footer %}{% end %}
        </footer>
    </body>
</html>
```
![Hello World!](images/3-1.png)

*图3-1, Hello World!*

就可以从扩展该父模板*main.html*时，从子模板*index.html*引用这些区块。

```python
{% extends "main.html" %}
{% block header %}
    <h1>{{ header_text }}</h1>
{% end %}
{% block body %}
    <p>Hello from the child template!</p>
{% end %}
{% block footer %}
    <p>{{ footer_text }}</p>
{% end %}
```

Python脚本就像以前一样装入该子模板，除了在本例中会传入一些用在该模板中的字串变量（如图3-2所示）。

```python
class MainHandler(tornado.web.RequestHandler):
    def get(self):
        self.render(
            "index.html",
            header_text = "Header goes here",
            footer_text = "Footer goes here"
        )
```
![模板区块基础](images/3-2.png)

*图3-2, 模板区块基础*

在**父模块的区块语句中，同样可以放入默认文本及标签**，在扩展模板（子模板）没有指定其自己版本的该区块时，这些默认文本和标签就会按原样渲染出来。如此而来，就可以根据页面的不同，而仅替换那些需要替换的内容，**这在要包含或替换脚本、CSS文件及标签块时，尤其有用**。

![模板区块报错](images/3-3.png)

*图3-3, 模板区块报错*

> 如同在模板文档中指出的那样，”当前的报错功能......嘛，有意思哦。（error-reporting is currently...uh, interesting.）“ 语法错误或`{% block %}`语句未能闭合，会导致直接将`500: Internal Server Error`打印输出给浏览器(或是在`debug`模式下运行时完整的Python栈回溯，见图3-3)(A syntax mistake or failure to close `{% block %}` statements can result in `500: Internal Server Error(or a full Python stack trace, if you are running in `debug` mode) being printed directly out to the browser`）。

###实践中的模板：博特的书籍

**Templates in Practice: Burt's Books**

那么听起来这两个特性很有意思，而又无法设想该在标准web应用中该怎么去用到它们？就让我们来看看这里的一个示例吧，在这里我们的朋友Burt运营了一家名为Burt's Books的书店。

Burt在他的店里买着很多书，而他的网站需要展示一些不同的内容，比如新到的书、店面信息等等。Burt想要站点有着一致的观感，同时又要能够容易地更新页面和页面区域。

要实现这点，Burt's Books就要有一个基于Tornado的网站，该网站使用带有所有样式、布局及页面头部/底部细节的主模板，然后采用轻量的子模板来处理各个页面。在部署了这个系统后，Burt就可以为新书发布、招聘信息、活动预告等等页面放在一起，这些页面共用一些同样的基本属性（To do this, Burt's Books has a Tornado-based website that uses a main template with all the style, layout, and header/footer details, and then used lightweight child templates to handle pages. With this system in place, Burt can put together pages for new release, employee recommendations, upcoming events, and more, all sharing common base attributes）。

Burt's Books网站使用了一个叫做`main.html`的主要基本模板，该模板包含了该站点的一般结构，像下面这样。

```html
<!DOCTYPE html>
<html>
    <head>
        <title>{{ page_title }}</title>
        <line rel="stylesheet" href="{{ static_url("css/style.css") }}" >
    </head>

    <body>
        <div id="container">
            <header>
                {% block header %}<h1>Burt's Books</h1>{% end %}
            </header>
            <div id="main">
                <div id="content">
                    {% block body %}{% end %}
                </div>
            </div>
            <footer>
                {% block footer %}{% end %}
        For more information about our selection, hours or events, 请发邮件给：
        <a href="mailto:contact@burtsbooks.com">contact@burtsbooks.com</a>
            </footer>
        </div>
        <script src="{{ static_url("js/script.js") }}"></script>
    </body>
</html>
```

这个页面定义了网站页面结构，应用了一个CSS样式表，并装入主要JavaScript文件。其它模板可对此进行扩展，并对必要的头部、页面主体及底部三个区块（blocks）进行替换。

站点首页（*index.html*）问候友好的网站访客，并提供有关书店的信息。通过扩展*main.html*，该文件只需包含替换了头部和页面主体区块的信息。

```html
{% extends "main.html" %}

{% block header %}
    <h1>{{ header_text }}</h1>
{% end %}

{% block body %}
    <div id="hello">
        <p>欢迎来到Burt's Books!</p>
        <p>......</p>
    </div>
{% end %}
```

这样做利用到该Tornado模板（*main.html*）页面底部区块默认行为, 并留下继承自父模板的联系信息。

而服务于站点，并将信息传递给首页模板（To serve the site and pass information to the index template），Burt's Books网站应运行下面的Python脚本(*main.py*)。

```python
#!/usr/bin/env python2.7
# -*-coding: utf-8-*-

import tornado.web
import tornado.httpserver
import tornado.ioloop
import tornado.options
import os.path

from tornado.options import define, options
define("port", default=8000, help="在指定端口上运行", type=int)


class Application(tornado.web.Application):
    def __init__(self):
        handlers = [
            (r"/", MainHandler)
        ]

        settings = dict(
            template_path=os.path.join(os.path.dirname(__file__), "templates"),
            static_path=os.path.join(os.path.dirname(__file__), "static"),
            debug=True,
        )
        tornado.web.Application.__init__(self, handlers, **settings)


class MainHandler(tornado.web.RequestHandler):
    def get(self):

        self.render(
            "index.html",
            page_title="Burt's Books | Home",
            header_text="欢迎来到Burt's Books!"
        )

if __name__ == "__main__":
    tornado.options.parse_command_line()
    http_server = tornado.httpserver.HTTPServer(Application())
    http_server.listen(options.port)
    tornado.ioloop.IOLoop.instance().start()
```

> 本例的结构与之前见到的有所不同，但没什么好害怕的。与其通过调用带有一个处理器列表和其他关键字参数(a list of handlers and other keyword arguments)的`tornado.web.Application`的构建器来创建出一个该类（`tornado.web.Application`）的实例（aka, object, 对象）, 我们直接定义了自己的应用程序子类，程序里就简单地称之为`Application`了。在我们定义的`__init__`方法中，我们创建了处理器列表及一个设置字典（the list of handlers and aa dictionary of settings）, 并将这些值像下面这样传递到初始化该子类的调用中。
> ```python
>   tornado.web.Application.__init__(self, handlers, **settings)
>```

那么在部署了本系统后，Burt's Books网站就可以很容易地对首页进行改变，同时保持基本模板（*main.html*）原封不懂地为其它页面所使用。此外，他们还可用上Tornado真正威力，将来自Python脚本及/或数据库的动态内容提供给访客。稍后就会对此进行探究。

###自动转换

**Autoescaping**

默认情况下，Tornado会自动*转换*模板中的内容，将那些标签转换成它们对应的HTML实体（By default, Tornado will automatically *escape* content in templates, turning tags into their associated HTML entities）。这样做保护了那些数据库驱动的网站（database-backed websites）免受恶意脚本的攻击。比如说站点有一个评论版块，用户在那里可将他们想要的任意文本作为讨论的一部分加入进去。尽管一些诸如标记和样式冲突（像是评论中未封闭的`<h1>`）的HTML标签不会造成明显的威胁，但一些未转换的`<script>`标签却可以令到攻击者载入外部JavaScript文件，为其开启跨站点脚本攻击漏洞之门（unscaped `<script>` tags can allow attacks to load external JavaScript files, openning up the door for cross-site scripting, or XSS, vulnerabilities）。

我们来看看Burt's Books站点上的一个用户反馈页面。Melvin, 今天感到相当恶意，就会利用评论表单提交如下的文本。

```html
Totally hacked your site lulz »
<script>alert('RUNN1NG 3V1L H4CK5 4ND 5PL01T5 N0W...')</script>
```

当在给不受信任用户构建页面，却没有对用户内容进行转换时，该脚本标签就会被浏览器作为一个HTML元素进行解释并执行，所以Alice就会看到如图3-4所示的告警窗口。还好啦，Tornado将会自动对两个双尖括号之间的表达式进行转换。对Melvin早前输入的文件的转换将令到HTML标签失去活性，并渲染出以下文本（Thankfully, Tornado will automatically escape the expressions rendered between double curly braces. Escaping the text Melvin entered earlier will inactivate HTML tags and render the following string）。

```html
Totally hacked your site lulz »
&lt;script&gt;alert('RUNNING EVIL H4CKS AND SPL01TS NOW...')&lt;/script&gt;
```

